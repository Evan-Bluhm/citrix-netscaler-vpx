---
copyright:
  years: 1994, 2017

lastupdated: "2017-11-02"
---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}

# Citrix Netscaler VPX をフォワード・プロキシーとしてセットアップ

フォワード・プロキシーは、内部ネットワーク上のクライアントとインターネットの間の単一の制御ポイントとして機能します。プロキシーにより、ネットワーク管理者またはセキュリティー管理者は、インターネット・サイトへのアクセスを制限するポリシーを作成できます。

内部ネットワーク上のクライアントが要求を開始すると、プロキシーの IP アドレスを使用して、インターネット上のリモート・サーバーへの要求が開始されます。次に、リモート・サーバーはプロキシーに応答し、プロキシーはクライアントに応答を返します。

通常、プロキシーはファイアウォールと結合されて、内部ネットワーク内のクライアントのセキュリティーを確保します。

## ステップ 1: プライベート・ネットワークで使用する VIP の要求 

Citrix NetScaler VPX ロード・バランサーが {{site.data.keyword.BluSoftlayer_notm}} カスタマー・ポータルから発注されると、リバース・プロキシーが要求されていると想定されます。要求者は、仮想 IP (VIP) として使用される「パブリック」IP の数を求められます。

フォワード・プロキシーの場合、プライベート・ネットワーク上に VIP をセットアップする必要があります。プライベート・ネットワークの VIP を要求するには、サポート・チケットをオープンする必要があります。 必要な VIP の数によって、チケットで要求されるサブネットのサイズが決まります。サブネット情報がチケットで返されます。

この例では、`/29` サブネットを要求しました。その結果、以下のようになりました。

* プライベート VIP として使用するためのサブネット `10.114.27.0/29` が作成されました。

* サブネット IP (SNIP) `10.114.52.101`、およびルーティングされたサブネット `10.114.27.0/29`

* VIP `10.114.27.0-3` が、サポート・チームによって Citrix NetScaler VPX に追加されました。

## ステップ 2: Citrix NetScaler VPX でのロード・バランシング機能およびキャッシュ・リダイレクト機能の有効化

デフォルトでは、Citrix NetScaler VPX ロード・バランサーのロード・バランシング機能とキャッシュ・リダイレクト機能は無効になっています。`enable ns feature cr lb` コマンドは、これらの機能を有効にします。


## ステップ 3: フォワード・プロキシーの作成

コマンド・ラインを使用して、Citrix NetScaler VPX に対して以下のコマンドを発行します。このシナリオでは、2 台の {{site.data.keyword.BluSoftlayer_notm}} DNS サーバーのうち 1 台のみが追加されます。  

```
add cr vserver vs_forward_cache HTTP 10.114.27.3 80 -cachetype forward -redirect origin

add lb vserver virtual_dns DNS 10.114.27.4 53

add service Real_DNSServer 10.0.80.12 DNS 53

bind lb vserver virtual_dns Real_DNS

set cr vserver vs_forward_cache -dnsVservername virtual_dns
```

1 行目ではリダイレクト・キャッシュが作成されます。プロトコルは HTTP で、`10.114.27.3` はプライベート・ネットワークで要求される VIP の 1 つです。ポートは HTTP のデフォルト・ポート 80 ですが、このアドレスとポートの組み合わせがブラウザーでプロキシー・ステートメントとして使用されるため、ポートは必要に応じて変更できます。

2 行目は、「実際の」DNS を表すロード・バランシング VIP を追加します。

3 行目は、「実際の」DNS の IP アドレスをサービスとして追加します。このアドレスは、カスタマー DNS にすることも、{{site.data.keyword.BluSoftlayer_notm}} 提供の DNS リゾルバーに戻すこともできます。

4 行目では、VIPを「実際の」サーバーにバインドします。`10.114.27.4` に対するすべての DNS 要求は `10.0.80.12` に送信されます。

5 行目では、フォワード・プロキシー仮想サーバーに対して、名前解決に仮想 DNS を使用するよう指示しています。

## クライアントの構成

フォワード・プロキシーを使用するようにクライアントのカスタマイズを続行する前に、クライアント上の Firefox ブラウザーを使用してパブリック・サイト (例えば、http://www.ibm.com) に到達できないことを確認してください。クライアントにはパブリック・インターフェースがないため、この要求は失敗するはずです。 

以下の例では、Linux クライアントを構成します。

クライアントに対していくつかの変更を加える必要があります。最初の変更は、クライアント上のリゾルバーが仮想 DNS サーバーを指すようにすることです。これは、次の 2 つの方法のいずれかで実行できます。

`/etc/resolv.conf` を手動で編集して、DNS の仮想アドレスを指すようにすることができます。クライアント管理ツールがこれらの変更を元の設定に戻す可能性があることに注意してください。  

あるいは、`/ etc/sysconfig/network-scripts/ifcfg-ethx` インターフェースを編集し、`DNS1 =` ステートメントを追加することもできます。いったん設定されたら、サービス・ネットワーク再始動コマンドを発行して変更を取得できます。

いずれの場合も、DNS IP アドレスを仮想 DNS アドレスとして構成する必要があり、要求が Citrix NetScaler VPX フォワード・プロキシーを指すようにクライアントのブラウザーを構成する必要があります。

Firefox 内で以下のステップを実行して、必要な変更を行います。

1. **「設定 (Preferences)」>「拡張 (Advanced)」>「ネットワーク (Network)」>「接続設定 (Connection Settings)」**をクリックします。

* **「手動でプロキシを設定する (Manual Proxy Configuration)」**を選択し、以下を入力します。

  * **アドレス:** 10.114.27.3

  * **ポート:** 80

  * **「すべてのプロトコルでこのプロキシを使用する (Use this proxy server for all protocols)」**チェック・ボックスにチェック・マークを付けます。

* **「保存 (Save)」**をクリックし、ブラウザー・ウィンドウを閉じます。

IP アドレス `10.114.27.3` は、ステップ 1 で作成した転送キャッシュの IP アドレスです。

この時点でセットアップが完了し、プライベート・ネットワーク上の分離されているリソースからインターネットにアクセスできます。

## セットアップの検証

クライアントがフォワード・プロキシーを使用するように構成されたので、パブリック・サイトへのアクセスを再試行します。今度は、要求が正常に実行されるはずです。

以下の表示コマンドを使用して、フォワード・プロキシーの状態を検証できます。

**show cr policy:** 既存のすべてのキャッシュ・リダイレクト・ポリシーを表示します。

**show policy map:** 構成済みのマップ・ポリシーと、関連するマップ・ポリシー情報を表示します。

**show cr vserver:** 指定されたキャッシュ・リダイレクト仮想サーバー、またはすべての構成済みキャッシュ・リダイレクト仮想サーバーを表示します。

**stat cr vserver:** キャッシュ・リダイレクト vserver 統計を表示します。

詳細な資料については、[「Citrix コマンド・リファレンス・ガイド (英語)」![外部リンク・アイコン](../../icons/launch-glyph.svg "外部リンク・アイコン")](https://support.citrix.com/servlet/KbServlet/download/20679-102-665857/NS-CommandReference-Guide.pdf) を参照してください。

Citrix での基本フォワード・プロキシーの構成は、かなり単純です。これにより、内部ネットワーク上のクライアントにインターネット上のリソースへのセキュア・パスを提供できます。また、ネットワーク管理者は、ネットワークに対する制御のレベルを維持することができます。

お客様のサイトで実装する場合は、リソースをさらに保護するために、ファイアウォールを構成に追加することをお勧めします。
